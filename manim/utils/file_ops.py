import os
import subprocess as sp
import platform
import numpy as np


def add_extension_if_not_present(file_name, extension):
    # This could conceivably be smarter about handling existing differing extensions
    if file_name[-len(extension) :] != extension:
        return file_name + extension
    else:
        return file_name


def guarantee_existence(path):
    if not os.path.exists(path):
        os.makedirs(path)
    return os.path.abspath(path)


def seek_full_path_from_defaults(file_name, default_dir, extensions):
    possible_paths = [file_name]
    possible_paths += [
        os.path.join(default_dir, file_name + extension)
        for extension in ["", *extensions]
    ]
    for path in possible_paths:
        if os.path.exists(path):
            return path
    raise IOError("File {} not Found".format(file_name))


def get_sorted_integer_files(
    directory,
    min_index=0,
    max_index=np.inf,
    remove_non_integer_files=False,
    remove_indices_greater_than=None,
    extension=None,
):
    indexed_files = []
    for file in os.listdir(directory):
        if "." in file:
            index_str = file[: file.index(".")]
        else:
            index_str = file

        full_path = os.path.join(directory, file)
        if index_str.isdigit():
            index = int(index_str)
            if remove_indices_greater_than is not None:
                if index > remove_indices_greater_than:
                    os.remove(full_path)
                    continue
            if extension is not None and not file.endswith(extension):
                continue
            if index >= min_index and index < max_index:
                indexed_files.append((index, file))
        elif remove_non_integer_files:
            os.remove(full_path)
    indexed_files.sort(key=lambda p: p[0])
    return list(map(lambda p: os.path.join(directory, p[1]), indexed_files))


def open_file(file_path):
    current_os = platform.system()
    if current_os == "Windows":
        os.startfile(file_path)
    else:
        if current_os == "Linux":
            commands = ["xdg-open"]
        elif current_os.startswith("CYGWIN"):
            commands = ["cygstart"]
        elif current_os == "Darwin":
            commands = ["open"]
        else:
            raise OSError("Unable to identify your operating system...")
        commands.append(file_path)
        sp.Popen(commands)
